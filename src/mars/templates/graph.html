
{% extends "layouts/base.html" %}
{% block content %}
<body>
{% if graphResults %}
<!-- load the d3.js library -->
	<div class="container">
  	<div class="jumbotron" id="graphJtron">
    	<svg id="visualisation" width="1000" height="500"></svg>

      	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script>
        	function InitChart() {
            //Change JSON string to object
            var GRAPH = JSON.parse('{{graphJSON|safe}}');

            var color = d3.scale.category10();


            var jumbowidth = document.getElementById("graphJtron").offsetWidth;
            console.log(jumbowidth);
            var jumboheight = document.getElementById("graphJtron").offsetHeight;
            console.log(jumboheight);

            var vis = d3.select("#visualisation"),
                WIDTH = jumbowidth *.8,
                HEIGHT = jumboheight*.8,
                MARGINS = {
                    top: 50,
                    right: 20,
                    bottom: 50,
                    left: 50
                },
								lSpace = WIDTH/GRAPH.length;

            var minX = Number.MAX_VALUE;
            var minY = Number.MAX_VALUE;
            var maxX = Number.MIN_VALUE;
            var maxY = Number.MIN_VALUE;

            //Update the min and maxX
            GRAPH.forEach(function (d,i) {
              //Creates an array of objects with key-value pairs, sorted by keys
              var reflectance = d3.entries(d.reflectance);
              var curX = 0;
              var cury = 0;
              for (var i=reflectance.length-1; i>=0; i--) {
                curX = parseFloat(reflectance[i].key);
                curY = parseFloat(reflectance[i].value);

                if (curX > maxX) maxX = curX;
                if (curX < minX) minX = curX;
                if (curY > maxY) maxY = curY;
                if (curY < minY) minY = curY;
              }
            });

            minX = minX *.95;
            minY = minY *.95;
            maxX = maxX * 1.05;
            maxY = maxY * 1.05;

            xScale = d3.scale.linear().range([MARGINS.left, WIDTH - MARGINS.right]).domain([minX,maxX]),
            yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([minY,maxY]),
            xAxis = d3.svg.axis()
                .scale(xScale),
            yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left");

            vis.append("svg:g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
                .call(xAxis);

            vis.append("svg:g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + (MARGINS.left) + ",0)")
                .call(yAxis);

          	vis.append("text")
          	   .attr("class", "x label")
          	   .attr("text-anchor", "end")
          	   .attr("x", WIDTH)
          	   .attr("y", HEIGHT)
          	   .text("Wavelength");

          	vis.append("text")
          	   .attr("class", "y label")
          	   .attr("text-anchor", "end")
          	   .attr("y", HEIGHT)
          	   .attr("dy", "-45em")
          	   .attr("transform", "rotate(-90)")
          	   .text("Reflectance");

            var lineGen = d3.svg.line()

                .x(function(d) {
                    return xScale(d.key);
                })
                .y(function(d) {
                    return yScale(d.value);
                })
                .interpolate("linear");

            //Define the function that sorts the data
            function keySort (sortfunc,field) {
              return function (a,b) {
                return sortfunc(parseFloat(a[field]),parseFloat(b[field]));
              }
            }

            GRAPH.forEach(function(d,i) {
                //Creates an array of objects with key-value pairs, sorted by keys
                var reflectanceKV = d3.entries(d.reflectance).sort(keySort(d3.ascending,"key"));

                //Append path to graph
                vis.append('svg:path')
                .attr('d', lineGen(reflectanceKV))   //d3.entries(d.reflectance).sort(keySort(d3.ascending,"key"))
                .attr('stroke', function(d,j) {
                        return "hsl(" + Math.random() * 360 + ",50%,50%)";
                })
                .attr('stroke-width', 2)
                .attr('id', 'line_'+d.data_id)
                .attr('fill','none');

                // Line Disappearing nonsense
                vis.append("text")
                    .attr("x", (lSpace/2)+i*lSpace)
                    .attr("y", HEIGHT)
                    .style("fill", "black")
                    .attr("class","legend")
                    .on('click',function() {
                        var active   = d.active ? false : true;
                        var opacity = active ? 0 : 1;
                        d3.select("#line_" + d.data_id).style("opacity", opacity);
                        d.active = active;
                    })
                    .text(d.data_id);
            });

          }

          InitChart();

          </script>
      </div>
      <br>
      <br>
      <br>
      <br>
  </div>
{% else%}
  <div id="meta">
    <h3><b> Please select a sample to graph.</b></h3>
  </div>
{% endif %}
</body>
{% endblock %}
