{% extends "layouts/base.html" %}
{% load staticfiles %}
{% block content %}
  {% if search_results %}
    <div class="container section">
      <div class="card section" style="background:rgba(255,255,255,.9)">
        <form id="resultsForm" method="POST" name="resultsform">
          {% csrf_token %}
          <div class="section center-align">
            <button type="submit" name="graphForm" formaction="/graph/" class="btn btn-success">Graph</button>
            <button type="submit" name="export" formaction="/export/" class="btn btn-success">Export</button>
            <button type="submit" name="meta" formaction="/meta/" class="btn btn-success">View Metadata</button><br>
          </div>
          <div class="container section">
            <div class="center-align">
              <label class="center-align" halign="center">
                Showing results {{page_results.start_index}}-{{page_results.end_index}} of {{page_results.paginator.count}}
              </label>
            </div>
            <input id="selectAllBox" type="checkbox" name="selection" onClick="toggle(this)"/>
            <label name="selectAllLabel" for="selectAllBox" > Select All</label>
          </div>
          <table class="table container striped highlight">
            <thead>
              <tr>
                <th></th>
                <th>ID</th>
                <th>Name</th>
                <th onclick="sortByField('sample_class')">Class</th>
                <th>Origin</th>
                <th>Grain Size</th>
                <th>Mineral Type</th>
                <th>Sample Type</th>
                <th>Reflectance Range</th>
              </tr>
            </thead>
            <tbody>
              {% for result in page_results %}
              <tr>
                {% if result.data_id.strip in selected_ids %}
                  <td>
                    <input type="checkbox" checked="checked" name="selection" id="option{{ result.data_id }}" value={{result.data_id}}/>
                    <label for="option{{result.data_id }}"></label>
                  </td>
                {% else %}
                  <td>
                    <input type="checkbox" name="selection" id="option{{ result.data_id }}" value={{result.data_id}}/>
                    <label for="option{{result.data_id }}"></label>
                  </td>
                {% endif %}
                <td><label for="option{{ result.data_id }}"> {{ result.data_id }}</label></td>
                <td><label for="option{{ result.data_id }}"> {{ result.name | title }} </label></td>
                <td><label for="option{{ result.data_id }}"> {{ result.sample_class }} </label></td>
                <td><label for="option{{ result.data_id }}"> {{ result.origin }} </label></td>
                <td><label for="option{{ result.data_id }}">{{ result.grain_size }} </label></td>
                <td><label for="option{{ result.data_id }}"> {{ result.mineral_type }} </label></td>
                <td><label for="option{{ result.data_id }}"> {{ result.sample_type }} </label></td>
                <td><label for="option{{ result.data_id }}"> {{ result.refl_range }} </label></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          {% for result in search_results %}
            <input type="hidden" name="search_results" value="{{result}}"/>
          {% endfor %}


          {% for id in selected_ids %}
            {% if id not in page_ids %}
              <input type="hidden" name="prev_selected" value="{{id}}"/>
            {% endif %}
          {% endfor %}


          <div class="section center-align">
            <button type="submit" name="graphForm" formaction="/graph/" class="btn btn-success">Graph</button>
            <button type="submit" name="export" formaction="/export/" class="btn btn-success">Export</button>
            <button type="submit" name="meta" formaction="/meta/" class="btn btn-success">View metadata</button><br>
          </div>

          {% if results_string %}
            <input type="hidden" name="results_string" value="{{results_string}}"/>
          {% endif %}

          {% if prev_selected %}
            <input type="hidden" name="prev_selected" value="{{prev_selected}}"/>
          {% endif %}

          {% for sort_param in sort_params %}
            <input type="hidden" name="sort_params" value="{{sort_param}}"/>
          {% endfor %}


          <!-- Pagination -->
          <input id="page_selected" type="hidden" name="page_selected" value="{{results.number}}"/>
          <input type="hidden" name="page_number" value="{{results.number}}"/>
          <ul class="pagination center-align">
            {% if page_results.has_previous %}
              <li class="waves-effect">
                <a onclick="selectPage({{page_results.previous_page_number}});" name="action" value="results"/>
                <i class="material-icons">chevron_left</i>
                </a>
              </li>
            {% else %}
              <li class="disabled">
                <a name="action" value="results"/>
                <i class="material-icons">chevron_left</i>
                </a>
              </li>
            {% endif %}

            {% for page in page_choices %}

            {% if page_results.number == page %}
              <li class="active">
                <a  name="action" value="results"/>
                {{page_results.number}}
                </a>
              </li>
            {% else %}
              <li class="waves-effect">
                <a onclick="selectPage({{page}});" name="action" value="results"/>
                {{page}}
                </a>
              </li>
            {% endif%}

            {% endfor %}

            {% if page_results.has_next %}
              <li class="waves-effect">
                <a onclick="selectPage({{page_results.next_page_number}});" name="action" value="results"/>
                <i class="material-icons">chevron_right</i>
                </a>
              </li>
            {% else %}
              <li class="disabled">
                <a name="action" value="results"/>
                <i class="material-icons">chevron_right</i>
                </a>
              </li>
            {% endif %}
          </ul>
        </form>

      </div>
    </div>
  {% else %}
    <div id="meta" class="container section">
      <div class="card-panel center-align" style="background:rgba(255,255,255,.8)">
        <p>Unfortunately, there are no samples that match your search. Try a different one.</p>
      </div>
    </div>
  {% endif %}

  <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
  <script>window.jQuery || document.write('<script src="{% static 'js/vendor/jquery-1.12.0.min.js' %}"><\/script>')</script>
  <script src="{% static 'js/plugins.js' %}"></script>
  <script src="{% static 'js/main.js' %}"></script>
  <script src="{% static 'js/materialize.min.js' %}"></script>

  <script language="JavaScript">
    // Select all toggle
    function toggle(source){
      checkboxes = document.getElementsByName("selection");
      for(var i=0, n=checkboxes.length; i<n; i++){
        checkboxes[i].checked = source.checked;
      }
    }

    // Pagination value. Allows user to select the next page
    function selectPage(pageNumber) {
      document.getElementById("page_selected").value = pageNumber;
      document.getElementById("resultsForm").submit();
    }

    // Sort results by fields. Allows user to sort the table by clicking on table header
    function sortByField(field) {
      var form = document.forms['resultsForm'];

      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'sort_params';
      input.value = field;
      form.appendChild(input);

      var sortParams = document.getElementsByName("sort_params");
      for (i = 0; i < sortParams.length; i++) {
        console.log(sortParams[i].value);
      }
    }

  </script>
{% endblock %}
